<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Point code → Route ID & Sequence</title>
  <meta name="description" content="Point code lookup met CSV via bestand, URL of plakken. Met native bestandskiezer (File System Access API) voor Android Chrome." />
  <style>
    :root { --bg:#0b1220; --fg:#e9f0ff; --muted:#9fb3d1; --card:#0f172a; --border:#1e293b; --ok:#67ff86; --err:#ff7a7a; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial}
    header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px} .brand img{height:46px;width:auto;border-radius:6px;background:#fff;padding:4px}
    .brand h1{margin:0;font-size:18px} .ver{color:var(--muted);font-size:13px}
    main{padding:18px;display:grid;grid-template-columns: 600px 1fr;gap:18px}
    @media (max-width:1100px){main{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden}
    .card h2{margin:0;padding:12px 16px;font-size:14px;color:var(--muted);border-bottom:1px solid var(--border)}
    .card .content{padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap} .row>*{flex:1 1 220px}
    input[type=file],input[type=text],textarea,button{width:100%;padding:14px 16px;border-radius:12px;border:1px solid var(--border);background:#0b1220;color:var(--fg);font-size:18px}
    textarea{min-height:160px;background:#0b1327}
    input.big{font-size:28px;font-weight:700;letter-spacing:.5px}
    button.primary{background:#1d4ed8;border-color:#1e40af}
    button.secondary{background:#0b1327}
    #out{background:#07101f;border:1px solid var(--border);border-radius:16px;padding:18px;min-height:140px}
    #big{font-size:48px;line-height:1.15;font-weight:900;letter-spacing:.5px;margin:0}
    #sub{font-size:18px;color:var(--muted);margin:8px 0 0 0}
    table{width:100%;border-collapse:collapse;margin-top:12px} th,td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:left;font-size:16px}
    .hint{color:var(--muted);font-size:14px;line-height:1.5} .ok{color:var(--ok)} .err{color:var(--err)}
    .pill{display:inline-flex;gap:8px;align-items:center;background:#0a162c;border:1px solid var(--border);border-radius:999px;padding:8px 12px;font-size:13px}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="logo.jpg" alt="Cavalart koerier logo"/>
      <div>
        <h1>Cavalart koerier • Point code lookup</h1>
        <div class="ver">v1.0.2 – 2025-09-17</div>
      </div>
    </div>
    <div class="pill">CSV via bestand • URL • plakken • <b>native picker</b></div>
  </header>

  <main>
    <section class="card">
      <h2>CSV laden</h2>
      <div class="content">
        <p class="hint"><b>Android advies:</b> open in <b>Chrome</b> (niet in een in‑app browser). Druk op <b>Kies CSV (Downloads)</b> voor de <i>native</i> bestandskiezer.</p>
        <div class="row">
          <button id="nativeBtn" class="primary">Kies CSV (Downloads)</button>
          <button id="clearBtn" class="secondary">Leegmaken</button>
        </div>
        <div class="row">
          <!-- Web-standaard input als fallback (sommige toestellen tonen toch gallery) -->
          <input type="file" id="csvfile" accept=".csv,text/csv,application/*,*/*" />
          <button id="loadFileBtn">Laad gekozen bestand</button>
        </div>
        <div class="row">
          <input type="text" id="csvUrl" placeholder="of plak hier een CSV-URL (https://.../routes.csv)" />
          <button id="loadUrlBtn">Laad CSV van URL</button>
        </div>
        <p class="hint">Lukt kiezen nog steeds niet? Plak dan de CSV-tekst hieronder en klik <b>Laad geplakte CSV</b>.</p>
        <textarea id="csvPaste" placeholder="Plak hier de CSV-tekst (Point code, Route ID, Route sequence)"></textarea>
        <div class="row"><button id="loadPasteBtn">Laad geplakte CSV</button></div>
        <div id="csvStatus" class="hint"></div>
      </div>
    </section>

    <section class="card">
      <h2>Zoeken op Point code</h2>
      <div class="content">
        <div class="row">
          <input type="tel" inputmode="numeric" pattern="[0-9]*" id="pointInput" class="big" placeholder="Typ bv. 25833 (BE/00 niet nodig)" autocomplete="one-time-code"/>
          <button id="searchBtn" class="primary">Zoek</button>
        </div>
        <div id="out">
          <p id="big">—</p>
          <p id="sub">Laad eerst een CSV en voer een Point code in.</p>
          <div id="tableWrap"></div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Tips</h2>
      <div class="content hint">
        <ul>
          <li>CSV blijft lokaal (client-side); data verlaat je toestel niet.</li>
          <li>Invoer: alleen cijfers nodig — matching negeert <b>BE</b> en voorloopnullen.</li>
          <li>Je kunt ook een <b>routes.csv</b> naast deze pagina hosten; die wordt automatisch geladen.</li>
        </ul>
      </div>
    </section>
  </main>

<script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
<script>
let db = [];
const csvStatus = document.getElementById('csvStatus');
const pointInput = document.getElementById('pointInput');
const big = document.getElementById('big');
const sub = document.getElementById('sub');
const tableWrap = document.getElementById('tableWrap');

function canonicalPoint(s){
  if (!s) return '';
  let x = String(s).toUpperCase().replace(/\s+/g, '');
  if (x.startsWith('BE')) x = x.slice(2);
  const m = x.match(/^0*(\d.*)$/); if (m) x = m[1];
  return x;
}

function afterLoad(rows, label){
  db = rows;
  db.forEach(row => { row.__canon = canonicalPoint(row['Point code']); });
  csvStatus.innerHTML = `<span class="ok">CSV geladen (${label}):</span> ${db.length} rijen`;
}

function parseWithPapa(src, label){
  Papa.parse(src, {
    header:true, skipEmptyLines:true,
    complete:(res)=> afterLoad(res.data, label),
    error:(err)=> csvStatus.innerHTML = `<span class="err">CSV fout (${label}):</span> ${err}`
  });
}

// --- Native file picker (File System Access API) ---
async function pickNativeCSV(){
  if (!window.showOpenFilePicker){
    csvStatus.innerHTML = '<span class="err">Native bestandskiezer niet beschikbaar, gebruik de fallback hieronder.</span>';
    return;
  }
  try{
    const [handle] = await window.showOpenFilePicker({
      types:[{ description: 'CSV files', accept: { 'text/csv': ['.csv'], 'application/*': ['.csv'], 'text/plain': ['.csv','.txt'] } }],
      excludeAcceptAllOption: false,
      multiple: false,
      startIn: 'downloads'
    });
    const file = await handle.getFile();
    parseWithPapa(file, 'native picker');
  }catch(e){
    if (e && e.name === 'AbortError') return;
    csvStatus.innerHTML = '<span class="err">Kon bestand niet openen via native picker.</span>';
  }
}

// --- Fallbacks ---
function loadFromInputFile(){
  const inp = document.getElementById('csvfile');
  const f = inp.files && inp.files[0];
  if (!f){ csvStatus.textContent = 'Geen bestand gekozen.'; return; }
  parseWithPapa(f, 'bestand');
}
function loadFromUrl(){
  const url = document.getElementById('csvUrl').value.trim();
  if(!/^https?:\/\//i.test(url)){ csvStatus.innerHTML = '<span class="err">Ongeldige URL</span>'; return; }
  Papa.parse(url, { download:true, header:true, skipEmptyLines:true,
    complete:(res)=> afterLoad(res.data, 'URL'),
    error:(err)=> csvStatus.innerHTML = `<span class="err">CSV fout (URL):</span> ${err}`
  });
}
function loadFromPaste(){
  const t = document.getElementById('csvPaste').value;
  if(!t.trim()){ csvStatus.textContent='Leeg tekstvak.'; return; }
  parseWithPapa(t, 'plakken');
}

function renderResults(rows){
  if(!rows || !rows.length){
    big.textContent = 'Geen resultaat';
    sub.textContent = 'Controleer je Point code of laad de juiste CSV.';
    tableWrap.innerHTML = ''; return;
  }
  const r = rows[0];
  const route = r['Route ID'] || '—';
  const seq = r['Route sequence'] || '—';
  big.textContent = `Route: ${route}   (seq ${seq})`;
  sub.textContent = rows.length > 1 ? `${rows.length} matches gevonden. Zie tabel hieronder.` : 'Exacte match.';
  let html = '';
  if(rows.length > 1){
    html += '<table><thead><tr><th>Point code</th><th>Route ID</th><th>Route sequence</th></tr></thead><tbody>';
    for(const row of rows) html += `<tr><td>${row['Point code']||''}</td><td>${row['Route ID']||''}</td><td>${row['Route sequence']||''}</td></tr>`;
    html += '</tbody></table>';
  }
  tableWrap.innerHTML = html;
}

function doSearch(){
  const q = canonicalPoint(pointInput.value);
  if(!q){ renderResults([]); return; }
  const rows = db.filter(row => (row.__canon || '') === q);
  renderResults(rows);
}

// Bindings
document.getElementById('nativeBtn').addEventListener('click', pickNativeCSV);
document.getElementById('loadFileBtn').addEventListener('click', loadFromInputFile);
document.getElementById('clearBtn').addEventListener('click', ()=>{ db = []; csvStatus.textContent = 'Leeg.'; renderResults([]); });
document.getElementById('loadUrlBtn').addEventListener('click', loadFromUrl);
document.getElementById('loadPasteBtn').addEventListener('click', loadFromPaste);
document.getElementById('searchBtn').addEventListener('click', doSearch);
pointInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') doSearch(); });

// Auto-load routes.csv als aanwezig
(async function tryAutoLoad(){
  try{
    const res = await fetch('routes.csv', { method:'HEAD' });
    if(res.ok){
      Papa.parse('routes.csv', { download:true, header:true, skipEmptyLines:true,
        complete:(r)=> afterLoad(r.data, 'routes.csv') });
    }
  }catch(_ ){}
})();
</script>
</body>
</html>
