<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Point code → Route ID & Sequence</title>
  <meta name="description" content="Point code lookup met CSV via native bestandskiezer. Live zoeken tijdens typen. Geoptimaliseerd voor Android." />
  <style>
    :root { --bg:#0b1220; --fg:#e9f0ff; --muted:#9fb3d1; --card:#0f172a; --border:#1e293b; --ok:#67ff86; --err:#ff7a7a; --accent:#1d4ed8; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial}
    header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:46px;width:auto;border-radius:6px;background:#fff;padding:4px}
    .brand h1{margin:0;font-size:18px;line-height:1.2;font-weight:750}
    .ver{color:var(--muted);font-size:13px}
    main{padding:18px;max-width:1000px;margin:0 auto;display:grid;gap:18px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden}
    .card h2{margin:0;padding:12px 16px;font-size:14px;color:var(--muted);border-bottom:1px solid var(--border)}
    .card .content{padding:16px}
    button{width:100%;padding:16px;border-radius:12px;border:1px solid var(--border);background:var(--accent);color:#fff;font-size:18px;font-weight:700}
    button.secondary{background:#0b1327;color:var(--fg)}
    .hint{color:var(--muted);font-size:14px;line-height:1.5}
    #statusBar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .badge{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:8px 12px;font-size:13px;background:#0a162c}
    .badge.ok{border-color:#1f5130;background:#0f2c19;color:var(--ok)}
    .badge.err{border-color:#612626;background:#2a0f14;color:var(--err)}
    #out{background:#07101f;border:1px solid var(--border);border-radius:16px;padding:18px;min-height:140px}
    #big{font-size:52px;line-height:1.15;font-weight:900;letter-spacing:.5px;margin:0;min-height:62px}
    #sub{font-size:18px;color:var(--muted);margin:8px 0 0 0;min-height:24px}
    input[type=tel]{width:100%;padding:16px 18px;border-radius:12px;border:1px solid var(--border);background:#0b1327;color:var(--fg);font-size:28px;font-weight:700;letter-spacing:.5px}
    table{width:100%;border-collapse:collapse;margin-top:12px} th,td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:left;font-size:16px}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="logo.jpg" alt="Cavalart koerier logo"/>
      <div>
        <h1>Cavalart koerier • Point code lookup</h1>
        <div class="ver">v1.0.3 – 2025-09-17</div>
      </div>
    </div>
  </header>

  <main>
    <section class="card">
      <h2>1) CSV laden</h2>
      <div class="content">
        <p class="hint"><b>Android/Chrome:</b> tik hieronder op <b>Kies CSV (Downloads)</b> en selecteer je CSV uit de map <i>Downloads</i>.</p>
        <button id="nativeBtn">Kies CSV (Downloads)</button>
        <div id="statusBar">
          <span id="csvStatus" class="badge err">Nog geen CSV geladen</span>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>2) Resultaat</h2>
      <div class="content">
        <div id="out">
          <p id="big">—</p>
          <p id="sub">Laad eerst een CSV.</p>
          <div id="tableWrap"></div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>3) Point code invullen</h2>
      <div class="content">
        <input type="tel" inputmode="numeric" pattern="[0-9]*" id="pointInput" placeholder="Typ bv. 25833 (BE/00 niet nodig)" autocomplete="one-time-code" disabled />
        <p class="hint">Je hoeft niet op 'Zoek' te klikken — het zoeken gebeurt automatisch tijdens het typen.</p>
      </div>
    </section>
  </main>

<script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
<script>
let db = [];
let debounceTimer = null;

const csvStatus = document.getElementById('csvStatus');
const pointInput = document.getElementById('pointInput');
const big = document.getElementById('big');
const sub = document.getElementById('sub');
const tableWrap = document.getElementById('tableWrap');

function canonicalPoint(s){
  if (!s) return '';
  let x = String(s).toUpperCase().replace(/\s+/g, '');
  if (x.startsWith('BE')) x = x.slice(2);
  const m = x.match(/^0*(\d.*)$/); if (m) x = m[1];
  return x;
}

function setLoadedBadge(count){
  csvStatus.className = 'badge ok';
  csvStatus.textContent = 'CSV geladen • ' + count + ' rijen';
  pointInput.disabled = false;
  pointInput.focus();
  pointInput.select();
}

function setNotLoadedBadge(msg){
  csvStatus.className = 'badge err';
  csvStatus.textContent = msg || 'Nog geen CSV geladen';
  pointInput.disabled = true;
}

function afterLoad(rows){
  db = rows;
  db.forEach(row => { row.__canon = canonicalPoint(row['Point code']); });
  setLoadedBadge(db.length);
  sub.textContent = 'Typ de point code hieronder.';
}

function parseWithPapa(src){
  Papa.parse(src, {
    header:true, skipEmptyLines:true,
    complete:(res)=> afterLoad(res.data),
    error:(err)=> setNotLoadedBadge('CSV fout: ' + err)
  });
}

// Native file picker
async function pickNativeCSV(){
  if (!window.showOpenFilePicker){
    setNotLoadedBadge('Native bestandskiezer niet beschikbaar. Update Chrome of open in Chrome.');
    return;
  }
  try{
    const [handle] = await window.showOpenFilePicker({
      types:[{ description: 'CSV files', accept: { 'text/csv': ['.csv'], 'application/*': ['.csv'], 'text/plain': ['.csv','.txt'] } }],
      excludeAcceptAllOption: false,
      multiple: false,
      startIn: 'downloads'
    });
    const file = await handle.getFile();
    parseWithPapa(file);
  }catch(e){
    if (e && e.name === 'AbortError') return;
    setNotLoadedBadge('Kon bestand niet openen via native picker.');
  }
}

function renderResults(rows){
  if(!rows || !rows.length){
    big.textContent = 'Geen resultaat';
    sub.textContent = 'Controleer je Point code of CSV.';
    tableWrap.innerHTML = '';
    return;
  }
  const r = rows[0];
  const route = r['Route ID'] || '—';
  const seq = r['Route sequence'] || '—';
  big.textContent = 'Route: ' + route + '   (seq ' + seq + ')';
  sub.textContent = rows.length > 1 ? (rows.length + ' matches gevonden. Zie tabel hieronder.') : 'Exacte match.';
  let html = '';
  if(rows.length > 1){
    html += '<table><thead><tr><th>Point code</th><th>Route ID</th><th>Route sequence</th></tr></thead><tbody>';
    for(const row of rows) html += '<tr><td>' + (row['Point code']||'') + '</td><td>' + (row['Route ID']||'') + '</td><td>' + (row['Route sequence']||'') + '</td></tr>';
    html += '</tbody></table>';
  }
  tableWrap.innerHTML = html;
}

function doSearch(){
  const q = canonicalPoint(pointInput.value);
  if(!q){ renderResults([]); return; }
  const rows = db.filter(row => (row.__canon || '') === q);
  renderResults(rows);
}

// Live zoeken tijdens typen (debounce)
pointInput.addEventListener('input', ()=>{
  if (debounceTimer) clearTimeout(debounceTimer);
  debounceTimer = setTimeout(doSearch, 120);
});

document.getElementById('nativeBtn').addEventListener('click', pickNativeCSV);
</script>
</body>
</html>
